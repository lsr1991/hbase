关于HBase存储数据的机制
---
#### 关于本文
本文分两部分。第一部分是查考资料时的阅读摘要。第二部分是资料的整理和总结。若要查考细节请看第一部分，若要把握整体流程请看第二部分。
#### 要点
 1. 客户端如何访问HBase
 2. 数据如何从客户端发送到HBase
 3. HBase如何将收到的数据写入磁盘
 4. HBase如何管理存储的数据

## 第一部分 阅读摘要
 - 关于RPC
  - RPC的概念（以下内容翻译自维基百科“remote procedure call”条目）：在计算机科学中，一个远程过程调用（RPC）是一个进程间通信，它允许一个计算机程序在另一个地址空间（通常在共享网络的另一台计算机上）调用并执行一个子程序或者过程，它不需要程序员为这次远程通信明确地用代码写出相应的细节。这就是说，无论子程序是在本地执行还是在远程机器上执行，程序员实质上写的是相同的代码。当所讨论的软件使用了面向对象原理时，RPC被称为“远程调用”或者“远程方法调用”。
  - RPC中信息的传递：一个RPC操作是被客户端初始化——客户端向一个已知的远程服务器发送一条请求信息，请求执行一个指定的过程并提供了参数。该远程服务器向客户端发送一个应答，然后服务器上的应用继续执行客户端上的程序。当服务器处理这次调用时，除非客户端向服务器发送一个同步请求（比如一个XHTTP调用），客户端会被锁住（它会一直等待直到服务器完成处理，然后才重新运行）。
  - RPC与本地调用的区别：一个重要的区别在于远程调用可能因为不可预测的网络问题而失败。另外，调用者一般得在不知道远程过程是否真地被启动的情况下处理这类失败。
  - 一次RPC操作的过程：
   - 客户端调用客户端存根。这个调用是本地过程调用，它把参数都以正常方式放入堆栈中。 
   - 客户端存根将参数打包进一个消息中并告诉系统将消息发出。打包参数的过程叫做封送处理（marshalling）。
   - 客户端的本地操作系统将消息从客户端机器发送至服务器机器上。
   - 服务器上的操作系统将收到的报文送到服务器存根中。
   - 服务器存根从消息中取出参数。
   - 最后，服务器存根调用服务器过程。服务器回复也是遵照相同的流程。
 - 关于put操作[1.p78]：HBase客户端API中的一个put操作都是一个RPC操作。一个RPC操作在LAN网络中大约花1毫秒的时间（这个时间不包括传输数据的时间，即与传输的数据大小无关，是固定时间开销），即一个服务器1秒只能处理1000次RPC操作，即1000次put操作。当应用程序每秒存储上千行数据时就会出现问题。
 - 减少RPC操作次数的方法[1.p78]：将多次修改操作批量提交到服务器，具体为：开启客户端缓冲区，即调用函数setAutoFlush(false)，这样每一次客户端执行put操作都会将修改的数据存储到客户端进程的内存中，当需要在特定时刻将多个操作数据一起发送至服务器时，调用函数flushCommits()即可，这时只会进行一次RPC操作。但调用flushCommits()通常是不必要的，因为当缓冲区大小达到设定的值（默认是2MB）时，客户端会隐式调用刷写命令。
 - 关于隐式刷写和显式刷写[1.p80]：显式刷写即用户代码调用flushCommits()；隐式刷写即客户端不通过用户代码，自己调用flushCommits()，这在以下三种情况下会触发：
   1. 用户调用put()并且缓冲区超出限制；
   2. 用户调用setWriteBufferSize()并且缓冲区超出限制；
   3. 用户调用HTable类的close()方法。
 - 关于HTable、HTablePool类及其实例[1.p68;1.p191]
   - HTable类及其实例：HBase主要客户端接口是由HTable类提供的，它位于org.apache.hadoop.hbase.client包中。创建HTable实例需要扫描.META.表并执行一些操作，非常耗时（数秒）。因此对于同一线程的多次请求，应复用同一个HTable实例。
   - HTablePool类及其实例：
     - 为什么使用HTablePool类？因为HTable类不是线程安全（什么是线程安全？）的，所以在多线程环境中复用HTable实例会出现问题，于是得为每一个线程创建一个HTable实例。
 - 关于客户端与服务器的连接[1.p194~195]：每个HTable实例（即客户端）都要与服务器建立连接。HBase内部的连接以键值对的形式存储。一个configuration实例作为一个键。即如果客户端使用同一个configuration实例，则它们共享一个连接，这可以使客户端初始化连接的开销（因为不用重复执行初始化）。共享连接的缺点是必须要用户显式关闭连接，连接才会断开。
 - 关于HBase中RPC的实现：客户端与服务器、服务器与服务器之间的通信，都使用到了Hadoop RPC框架。这个框架中需要远程方法中的参数都实现Writable接口，因此，HBase的API提供的大多数类（尤其是与管理功能相关的所有类）都实现了Hadoop Writable接口。这要求各个有通信需求的客户端、服务器上的HBase的jar包都是相同的，以确保Writable的实现相同。

